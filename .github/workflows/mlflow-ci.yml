name: MLflow CI/CD Pipeline - House Prices

on:
  push:
    branches:
      - main
    paths:
      - 'MLProject/**'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Manual trigger

env:
  PYTHON_VERSION: '3.12'
  MLFLOW_VERSION: '2.11.3'

jobs:
  train-model:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip wheel
        pip install setuptools==69.0.0
        pip install mlflow==${{ env.MLFLOW_VERSION }}
        pip install scikit-learn==1.4.0 pandas==2.2.0 numpy==1.26.3 scipy==1.12.0
        pip install matplotlib>=3.8.0 seaborn>=0.13.0 joblib>=1.3.0

    - name: ğŸ” Verify Installation
      run: |
        echo "Python version:"
        python --version
        echo ""
        echo "Installed packages:"
        pip list | grep -E "(mlflow|scikit-learn|pandas|numpy)"

    - name: ğŸ—ï¸ Run MLflow Project
      run: |
        cd MLProject
        echo "Starting MLflow training pipeline..."
        python modelling.py 200 15 42

    - name: ğŸ“Š Display Training Results
      run: |
        echo "=== Training Results ==="
        if [ -f "MLProject/artifacts/metrics_summary.json" ]; then
          cat MLProject/artifacts/metrics_summary.json
        else
          echo "Metrics summary not found"
        fi

    - name: ğŸ’¾ Upload Model Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trained-model-${{ github.run_number }}
        path: |
          MLProject/models/
          MLProject/artifacts/
          MLProject/mlruns/
        retention-days: 30
        compression-level: 6

    - name: ğŸ“ Commit Artifacts to Repository
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Add model artifacts (exclude large mlruns folder)
        git add MLProject/models/*.pkl || true
        git add MLProject/artifacts/*.png || true
        git add MLProject/artifacts/*.json || true

        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ¤– [CI] Update model artifacts - Run #${{ github.run_number }}"
          git push || echo "Push failed (might be protected branch)"
        fi
      continue-on-error: true

    - name: ğŸ“‹ Generate Training Report
      run: |
        cat << 'EOF' > $GITHUB_STEP_SUMMARY
        ## ğŸ¯ MLflow Training Pipeline - Results

        **Workflow Run:** #${{ github.run_number }}
        **Commit:** ${{ github.sha }}
        **Branch:** ${{ github.ref_name }}

        ### ğŸ“Š Model Performance

        EOF

        if [ -f "MLProject/artifacts/metrics_summary.json" ]; then
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat MLProject/artifacts/metrics_summary.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

        cat << 'EOF' >> $GITHUB_STEP_SUMMARY

        ### âœ… Artifacts Generated

        - ğŸ¯ Model file: `models/model.pkl`
        - ğŸ“ˆ Feature importance plot
        - ğŸ“Š Actual vs Predicted plot
        - ğŸ“„ Metrics summary JSON

        ### ğŸ“¥ Download Artifacts

        Artifacts are available in the **Artifacts** section below for 30 days.

        ---
        ğŸ¤– *Generated by MLflow CI/CD Pipeline*
        EOF

  build-docker:
    needs: train-model
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download Model Artifacts
      uses: actions/download-artifact@v4
      with:
        name: trained-model-${{ github.run_number }}
        path: MLProject/

    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install MLflow
      run: |
        pip install mlflow==${{ env.MLFLOW_VERSION }}

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”‘ Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      continue-on-error: true

    - name: ğŸ—ï¸ Build Docker Image with MLflow
      run: |
        cd MLProject

        # Check if mlruns exists
        if [ ! -d "mlruns" ]; then
          echo "âŒ MLruns directory not found"
          exit 1
        fi
        echo "âœ“ MLruns directory found"

        # List mlruns structure for debugging
        echo "MLruns structure:"
        ls -la mlruns/

        # Find experiment (directories with numeric names)
        EXPERIMENT_ID=$(find mlruns -maxdepth 1 -type d -name "[0-9]*" | head -1 | xargs basename)
        if [ -z "$EXPERIMENT_ID" ]; then
          echo "âŒ No experiment found"
          exit 1
        fi
        echo "âœ“ Experiment ID: $EXPERIMENT_ID"

        # List experiment contents
        echo "Experiment contents:"
        ls -la "mlruns/$EXPERIMENT_ID/"

        # Find run ID (any directory that's not meta.yaml or .trash)
        RUN_ID=$(find "mlruns/$EXPERIMENT_ID" -maxdepth 1 -type d ! -name "$EXPERIMENT_ID" ! -name ".*" | head -1 | xargs basename)
        if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "$EXPERIMENT_ID" ]; then
          echo "âŒ No run found in experiment $EXPERIMENT_ID"
          echo "Available items:"
          ls -la "mlruns/$EXPERIMENT_ID/"
          exit 1
        fi
        echo "âœ“ Run ID: $RUN_ID"

        MODEL_PATH="mlruns/${EXPERIMENT_ID}/${RUN_ID}/artifacts/model"

        # Verify model directory exists
        if [ ! -d "$MODEL_PATH" ]; then
          echo "âŒ Model not found at: $MODEL_PATH"
          echo "Run artifacts contents:"
          ls -la "mlruns/$EXPERIMENT_ID/$RUN_ID/artifacts/" || echo "Artifacts directory not found"
          exit 1
        fi
        echo "âœ“ Model found at: $MODEL_PATH"

        # List model contents
        echo "Model contents:"
        ls -la "$MODEL_PATH/"

        # Verify MLmodel file exists
        if [ ! -f "$MODEL_PATH/MLmodel" ]; then
          echo "âŒ MLmodel file not found - required for Docker build"
          exit 1
        fi
        echo "âœ“ MLmodel file found"

        # Build Docker image
        echo "ğŸ³ Building Docker image..."
        mlflow models build-docker \
          --model-uri "$MODEL_PATH" \
          --name "${{ secrets.DOCKERHUB_USERNAME }}/msml-model:latest"

        echo "âœ“ Docker image built successfully"
      continue-on-error: true
      env:
        DOCKER_BUILDKIT: 1

    - name: ğŸš€ Push Docker Image to Docker Hub
      run: |
        if docker images | grep -q "msml-model"; then
          echo "Pushing Docker image to Docker Hub..."
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/msml-model:latest || echo "Docker push failed"

          echo "### ğŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ secrets.DOCKERHUB_USERNAME }}/msml-model:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/msml-model:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "No Docker image found to push"
        fi
      continue-on-error: true

    - name: ğŸ§¹ Cleanup
      run: |
        docker system prune -f || true

  save-to-gdrive:
    needs: train-model
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Download Model Artifacts
      uses: actions/download-artifact@v4
      with:
        name: trained-model-${{ github.run_number }}
        path: artifacts-backup/

    - name: ğŸ“¦ Create Archive
      run: |
        cd artifacts-backup
        tar -czf ../model-artifacts-run-${{ github.run_number }}.tar.gz .
        cd ..
        ls -lh model-artifacts-run-${{ github.run_number }}.tar.gz

    - name: ğŸ’¾ Upload Backup Artifact
      uses: actions/upload-artifact@v4
      with:
        name: model-backup-${{ github.run_number }}
        path: model-artifacts-run-${{ github.run_number }}.tar.gz
        retention-days: 90
